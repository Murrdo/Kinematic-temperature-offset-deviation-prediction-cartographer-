[gcode_macro FIRST_LAYER_ANALYSIS]
description: Calculate total XY area from EXCLUDE_OBJECT and estimate first layer print time
variable_area: 0.0
variable_time_sec: 0.0
gcode:
    {% set line_width = params.LINE_WIDTH|default(0.5)|float %}
    {% set speed = params.SPEED|default(100)|int %}
    {% set ADD_PREP_TIME = params.ADD_PREP_TIME|default(85)|int %}

    {% set ns = namespace(total_area=0.0) %}

    {% if printer.exclude_object.objects %}
        {% for obj in printer.exclude_object.objects %}
            {% if 'polygon' in obj %}
                {% set poly = obj.polygon %}
                {% set n = poly|length %}

                {% if n >= 3 %}
                    {% set acc = namespace(area=0.0) %}
                    {% for i in range(n) %}
                        {% set x1 = poly[i][0] %}
                        {% set y1 = poly[i][1] %}
                        {% set x2 = poly[(i + 1) % n][0] %}
                        {% set y2 = poly[(i + 1) % n][1] %}
                        {% set acc.area = acc.area + (x1 * y2 - x2 * y1) %}
                    {% endfor %}

                    {% set poly_area = (acc.area | abs) / 2.0 %}
                    {% set ns.total_area = ns.total_area + poly_area %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% set ns_time = namespace(time=0.0) %}
    {% if ns.total_area > 0 and line_width > 0 and speed > 0 %}
        {% set path_len = ns.total_area / line_width %}
        {% set ns_time.time = (path_len / speed) + ADD_PREP_TIME %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=FIRST_LAYER_ANALYSIS VARIABLE=area VALUE={ns.total_area}
    SET_GCODE_VARIABLE MACRO=FIRST_LAYER_ANALYSIS VARIABLE=time_sec VALUE={ns_time.time}

    {% set area_str = "%.1f"|format(ns.total_area) %}
    {% set time_str = "%.1f"|format(ns_time.time) %}
    M118 Exclude area={area_str}mmÂ² First layer time= ~{time_str} sec.
